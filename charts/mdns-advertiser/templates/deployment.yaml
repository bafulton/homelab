apiVersion: apps/v1
kind: Deployment
metadata:
  name: mdns-advertiser
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mdns-advertiser
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mdns-advertiser
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: mdns
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              pip install --quiet zeroconf

              python3 -u << 'PYTHON_SCRIPT'
              from zeroconf import ServiceInfo, Zeroconf
              import socket
              import signal
              import time

              zc = Zeroconf()
              services = []

              def shutdown(signum, frame):
                  print("Shutting down mDNS advertiser...")
                  for info in services:
                      zc.unregister_service(info)
                  zc.close()
                  exit(0)

              signal.signal(signal.SIGTERM, shutdown)
              signal.signal(signal.SIGINT, shutdown)

              {{- range .Values.services }}
              {{- $svc := . }}
              # Register {{ .name }}
              print("Publishing {{ .name }} ({{ .ip }}:{{ .port }})")

              {{- range .types }}
              info = ServiceInfo(
                  "{{ .type }}.local.",
                  "{{ $svc.name }}.{{ .type }}.local.",
                  addresses=[socket.inet_aton("{{ $svc.ip }}")],
                  port={{ $svc.port }},
                  properties={
                      {{- if .txtRecords }}
                      {{- range .txtRecords }}
                      {{- $key := regexFind "^[^=]+" . }}
                      "{{ $key }}": "{{ trimPrefix (printf "%s=" $key) . }}",
                      {{- end }}
                      {{- end }}
                  },
                  server="{{ $svc.hostname }}.local."
              )
              zc.register_service(info, cooperating_responders=True)
              services.append(info)
              {{- end }}

              {{- end }}

              print("mDNS advertisements active")

              # Keep running
              while True:
                  time.sleep(60)
              PYTHON_SCRIPT
