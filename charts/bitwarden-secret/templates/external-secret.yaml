{{- range $.Values.secrets }}
{{- $secret := . }}
{{- $bitwardenData := dict }}
{{- $literalData := dict }}
{{- /* Separate data into Bitwarden UUIDs and literal values */ -}}
{{- range $secretKey, $value := .data }}
  {{- if include "bitwarden-secret.isUUID" $value }}
    {{- $_ := set $bitwardenData $secretKey $value }}
  {{- else }}
    {{- $_ := set $literalData $secretKey $value }}
  {{- end }}
{{- end }}
{{- $hasTargetMetadata := and .target (or .target.annotations .target.labels) }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .name }}
  {{- with .annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .labels }}
  labels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .refreshInterval | default $.Values.defaults.refreshInterval }}
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: {{ if .target }}{{ .target.name | default .name }}{{ else }}{{ .name }}{{ end }}
    creationPolicy: {{ .creationPolicy | default $.Values.defaults.creationPolicy }}
    deletionPolicy: {{ .deletionPolicy | default $.Values.defaults.deletionPolicy | default "Retain" }}
    {{- $needsTemplate := or $literalData $hasTargetMetadata }}
    {{- if $needsTemplate }}
    template:
      {{- if $hasTargetMetadata }}
      metadata:
        {{- with .target.annotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .target.labels }}
        labels:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      data:
        {{- range $secretKey, $literalValue := $literalData }}
        {{ $secretKey }}: {{ $literalValue | quote }}
        {{- end }}
        {{- range $secretKey, $_ := $bitwardenData }}
        {{ $secretKey }}: {{ printf "{{ .%s | toString }}" $secretKey | quote }}
        {{- end }}
    {{- end }}
  {{- if $bitwardenData }}
  data:
    {{- range $secretKey, $bitwardenId := $bitwardenData }}
    - secretKey: {{ $secretKey }}
      remoteRef:
        key: {{ $bitwardenId }}
        conversionStrategy: {{ if $secret.conversionStrategy }}{{ $secret.conversionStrategy }}{{ else }}Default{{ end }}
        decodingStrategy: {{ if $secret.decodingStrategy }}{{ $secret.decodingStrategy }}{{ else }}None{{ end }}
        metadataPolicy: {{ if $secret.metadataPolicy }}{{ $secret.metadataPolicy }}{{ else }}None{{ end }}
    {{- end }}
  {{- end }}
{{- end }}
