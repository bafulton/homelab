{{- range $.Values.secrets }}
{{- $secret := . }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .name }}
  {{- with .annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .labels }}
  labels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .refreshInterval | default $.Values.defaults.refreshInterval }}
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: {{ if .target }}{{ .target.name | default .name }}{{ else }}{{ .name }}{{ end }}
    creationPolicy: {{ .creationPolicy | default $.Values.defaults.creationPolicy }}
    deletionPolicy: {{ .deletionPolicy | default $.Values.defaults.deletionPolicy | default "Retain" }}
    {{- if and .target (or .target.annotations .target.labels) }}
    template:
      metadata:
        {{- with .target.annotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .target.labels }}
        labels:
          {{- toYaml . | nindent 10 }}
        {{- end }}
    {{- end }}
  data:
    {{- range $secretKey, $bitwardenId := .data }}
    - secretKey: {{ $secretKey }}
      remoteRef:
        key: {{ $bitwardenId }}
        conversionStrategy: {{ if $secret.conversionStrategy }}{{ $secret.conversionStrategy }}{{ else }}Default{{ end }}
        decodingStrategy: {{ if $secret.decodingStrategy }}{{ $secret.decodingStrategy }}{{ else }}None{{ end }}
        metadataPolicy: {{ if $secret.metadataPolicy }}{{ $secret.metadataPolicy }}{{ else }}None{{ end }}
    {{- end }}
{{- end }}
