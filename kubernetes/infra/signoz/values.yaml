namespace: signoz

# Ignore Kubernetes runtime defaults that cause perpetual drift
ignoreDifferences:
  # ClickHouse operator metrics-exporter adds divisor: "0" defaults to resourceFieldRef
  - group: apps
    kind: Deployment
    name: signoz-clickhouse-operator
    jqPathExpressions:
      - .spec.template.spec.containers[].env[].valueFrom.resourceFieldRef.divisor

# Gateway API HTTPRoute for private access
gateway-route:
  routes:
    - name: ui
      hostnames:
        - signoz.catfish-mountain.com
      service:
        name: signoz
        port: 8080

# API token for loading dashboards/alerts via GitOps
# Create token in SigNoz: Settings → API Tokens → Generate
# Store in Bitwarden and update the secret ID below
bitwarden-secret:
  secrets:
    - name: signoz-api-token
      data:
        token: "fa8aa5d0-f1d2-4de3-a1a8-b3c9003c2a52"
    - name: signoz-smtp-credentials
      data:
        password: "3425e9f2-f25a-400b-bd62-b3ca003efc3f"

signoz:
  clusterName: homelab

  # Disable Helm hooks - ArgoCD handles sync waves differently
  # Without this, otel-collector waits for a sync-init job that never gets created
  schemaMigrator:
    upgradeHelmHooks: false

  # Use longhorn-nvme for all SigNoz PVCs (ClickHouse, Zookeeper, SigNoz DB)
  # Moved from emmc to free space for smaller apps
  global:
    storageClass: longhorn-nvme

  clickhouse:
    persistence:
      enabled: true
      size: 50Gi
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9363"
    # Disable ClickHouse system logs to save disk space (~6.5GB)
    # These are internal operational logs, not SigNoz observability data
    # Re-enable query_log temporarily if debugging slow queries
    files:
      config.d/disable_system_logs.xml: |
        <clickhouse>
          <query_log remove="1"/>
          <query_thread_log remove="1"/>
          <query_views_log remove="1"/>
          <processors_profile_log remove="1"/>
          <part_log remove="1"/>
          <trace_log remove="1"/>
          <metric_log remove="1"/>
          <asynchronous_metric_log remove="1"/>
          <asynchronous_insert_log remove="1"/>
          <zookeeper_log remove="1"/>
          <session_log remove="1"/>
          <blob_storage_log remove="1"/>
          <backup_log remove="1"/>
          <crash_log remove="1"/>
        </clickhouse>
    zookeeper:
      heapSize: 256
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9141"
    clickhouseOperator:
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8888"

  otelCollector:
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8888"

  signoz:
    persistence:
      enabled: true
      size: 1Gi
    env:
      SIGNOZ_ALERTMANAGER_SIGNOZ_GLOBAL_SMTP__SMARTHOST: "smtp.gmail.com:587"
      SIGNOZ_ALERTMANAGER_SIGNOZ_GLOBAL_SMTP__FROM: "fulton.benjamin@gmail.com"
      SIGNOZ_ALERTMANAGER_SIGNOZ_GLOBAL_SMTP__AUTH__USERNAME: "fulton.benjamin@gmail.com"
      SIGNOZ_ALERTMANAGER_SIGNOZ_GLOBAL_SMTP__REQUIRE__TLS: "true"
      SIGNOZ_ALERTMANAGER_SIGNOZ_GLOBAL_SMTP__AUTH__PASSWORD:
        valueFrom:
          secretKeyRef:
            name: signoz-smtp-credentials
            key: password
