apiVersion: batch/v1
kind: Job
metadata:
  name: signoz-dashboard-sync
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: loader
          image: alpine:3.21
          env:
            - name: SIGNOZ_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: signoz-api-token
                  key: token
            - name: SIGNOZ_URL
              value: "http://signoz.{{ .Release.Namespace }}.svc:8080"
            - name: REPO_URL
              value: "https://github.com/bafulton/homelab.git"
            - name: REPO_PATH
              value: "kubernetes/infra/signoz"
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              apk add --no-cache curl jq git

              # Clone repo (shallow, specific path)
              echo "Cloning repository..."
              git clone --depth 1 --filter=blob:none --sparse "$REPO_URL" /repo
              cd /repo
              git sparse-checkout set "$REPO_PATH"

              # Wait for SigNoz to be ready
              echo "Waiting for SigNoz API to be ready..."
              for i in $(seq 1 30); do
                if curl -sf "$SIGNOZ_URL/api/v1/health" > /dev/null 2>&1; then
                  echo "SigNoz API is ready"
                  break
                fi
                echo "  Attempt $i/30 - waiting..."
                sleep 5
              done

              # Load dashboards (delete existing by title, then create)
              DASHBOARD_DIR="/repo/$REPO_PATH/dashboards"
              if [ -d "$DASHBOARD_DIR" ] && ls "$DASHBOARD_DIR"/*.json 1> /dev/null 2>&1; then
                echo "Loading dashboards..."

                # Get existing dashboards
                existing=$(curl -s "$SIGNOZ_URL/api/v1/dashboards" \
                  -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN")

                for f in "$DASHBOARD_DIR"/*.json; do
                  [ -f "$f" ] || continue
                  name=$(basename "$f" .json)
                  title=$(jq -r '.title // .data.title // empty' "$f")
                  echo "  Loading dashboard: $name (title: $title)"

                  # Find and delete ALL existing dashboards with same title
                  if [ -n "$title" ]; then
                    existing_ids=$(echo "$existing" | jq -r --arg t "$title" \
                      '.data[]? | select(.data.title == $t) | .id // empty' 2>/dev/null || true)
                    for existing_id in $existing_ids; do
                      if [ -n "$existing_id" ]; then
                        echo "    Deleting existing dashboard: $existing_id"
                        curl -s -X DELETE "$SIGNOZ_URL/api/v1/dashboards/$existing_id" \
                          -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN" > /dev/null
                      fi
                    done
                  fi

                  # Create dashboard
                  response=$(curl -s -w "\n%{http_code}" -X POST "$SIGNOZ_URL/api/v1/dashboards" \
                    -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d @"$f")

                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | sed '$d')

                  if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                    echo "    Created successfully"
                  else
                    echo "    Warning: HTTP $http_code - $body"
                  fi
                done
              else
                echo "No dashboards found"
              fi

              # Load alerts (delete existing by name, then create)
              ALERT_DIR="/repo/$REPO_PATH/alerts"
              if [ -d "$ALERT_DIR" ] && ls "$ALERT_DIR"/*.json 1> /dev/null 2>&1; then
                echo "Loading alerts..."

                # Get existing alerts
                existing_alerts=$(curl -s "$SIGNOZ_URL/api/v1/rules" \
                  -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN")

                for f in "$ALERT_DIR"/*.json; do
                  [ -f "$f" ] || continue
                  name=$(basename "$f" .json)
                  alert_name=$(jq -r '.alert // .data.alert // empty' "$f")
                  echo "  Loading alert: $name (name: $alert_name)"

                  # Find and delete ALL existing alerts with same name
                  if [ -n "$alert_name" ]; then
                    existing_ids=$(echo "$existing_alerts" | jq -r --arg n "$alert_name" \
                      '.data.rules[]? | select(.alert == $n) | .id // empty' 2>/dev/null || true)
                    for existing_id in $existing_ids; do
                      if [ -n "$existing_id" ]; then
                        echo "    Deleting existing alert: $existing_id"
                        curl -s -X DELETE "$SIGNOZ_URL/api/v1/rules/$existing_id" \
                          -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN" > /dev/null
                      fi
                    done
                  fi

                  # Create alert
                  response=$(curl -s -w "\n%{http_code}" -X POST "$SIGNOZ_URL/api/v1/rules" \
                    -H "SIGNOZ-API-KEY: $SIGNOZ_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d @"$f")

                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | sed '$d')

                  if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                    echo "    Created successfully"
                  else
                    echo "    Warning: HTTP $http_code - $body"
                  fi
                done
              else
                echo "No alerts found"
              fi

              echo "Config loading complete!"
