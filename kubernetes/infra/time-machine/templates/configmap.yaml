apiVersion: v1
kind: ConfigMap
metadata:
  name: time-machine-config
data:
  smb.conf: |
    [global]
    # Basic server settings
    workgroup = WORKGROUP
    server string = Time Machine Backup Server
    netbios name = timemachine
    netbios aliases = Time Machine
    security = user

    # Protocol settings - SMB3 required for Time Machine
    server min protocol = SMB2
    server max protocol = SMB3

    # Disable mDNS (we handle discovery separately if needed)
    multicast dns register = no

    # VFS modules for macOS compatibility
    vfs objects = catia fruit streams_xattr

    # Apple/macOS optimization settings (AAPL extensions)
    fruit:aapl = yes
    fruit:metadata = stream
    fruit:model = TimeCapsule8,119
    fruit:posix_rename = yes
    fruit:veto_appledouble = no
    fruit:nfs_aces = no
    fruit:copyfile = no
    fruit:wipe_intentionally_left_blank_rfork = yes
    fruit:delete_empty_adfiles = yes

    # Extended attributes support
    ea support = yes

    # Logging
    log file = /var/log/samba/log.%m
    max log size = 1000
    logging = file

    # Performance tuning
    socket options = TCP_NODELAY IPTOS_LOWDELAY
    read raw = yes
    write raw = yes

    # Disable printing
    load printers = no
    printing = bsd
    printcap name = /dev/null
    disable spoolss = yes

    {{- range .Values.users }}
    [{{ .name }}]
    comment = Time Machine Backup for {{ .name }}
    path = /opt/time-machine/{{ .name }}
    valid users = {{ .name }}
    browseable = yes
    writeable = yes

    # VFS modules (order matters)
    vfs objects = catia fruit streams_xattr

    # Time Machine specific settings
    fruit:time machine = yes
    fruit:time machine max size = {{ .quota }}

    # Permission masks
    create mask = 0600
    directory mask = 0700

    {{- end }}
