apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: time-machine
spec:
  serviceName: time-machine
  replicas: 1  # Never go > 1
  selector:
    matchLabels:
      app.kubernetes.io/name: time-machine
  template:
    metadata:
      labels:
        app.kubernetes.io/name: time-machine
    spec:
      # mDNS discovery handled by separate mdns-advertiser
      # MetalLB provides stable IP for LAN access
      containers:
        - name: time-machine
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Create Unix users and Samba accounts
              {{- range .Values.users }}
              echo "Setting up user {{ .name }}..."
              mkdir -p /opt/time-machine/{{ .name }}
              addgroup -g {{ .uid }} {{ .name }} 2>/dev/null || true
              adduser -D -u {{ .uid }} -G {{ .name }} -h /opt/time-machine/{{ .name }} {{ .name }} 2>/dev/null || true
              chown {{ .uid }}:{{ .uid }} /opt/time-machine/{{ .name }}
              chmod 700 /opt/time-machine/{{ .name }}
              echo -e "${PASSWORD_{{ .name | upper }}}\n${PASSWORD_{{ .name | upper }}}" | smbpasswd -a -s {{ .name }}
              {{- end }}

              echo "Users created, starting Samba..."
              exec /entrypoint.sh smbd -FS --no-process-group
          env:
            {{- range .Values.users }}
            - name: PASSWORD_{{ .name | upper }}
              valueFrom:
                secretKeyRef:
                  name: time-machine-credentials
                  key: {{ .name }}-password
            {{- end }}
            # Use our custom smb.conf and pre-created users
            - name: CUSTOM_SMB_CONF
              value: "true"
            - name: CUSTOM_USER
              value: "true"
            # mDNS/Bonjour settings
            - name: MIMIC_MODEL
              value: "TimeCapsule8,119"
            - name: ADVERTISED_HOSTNAME
              value: "time-machine"
            # General settings
            - name: DEBUG_LEVEL
              value: "1"
            - name: SMB_PORT
              value: "445"
            - name: WORKGROUP
              value: "WORKGROUP"
          ports:
            # NetBIOS ports (for discovery)
            - name: netbios-ns
              containerPort: 137
              protocol: UDP
            - name: netbios-dgm
              containerPort: 138
              protocol: UDP
            - name: netbios-ssn
              containerPort: 139
              protocol: TCP
            # SMB port
            - name: smb
              containerPort: 445
              protocol: TCP
          volumeMounts:
            - name: time-machine-data
              mountPath: /opt/time-machine
            - name: samba-config
              mountPath: /etc/samba/smb.conf
              subPath: smb.conf
            - name: samba-lib
              mountPath: /var/lib/samba
            - name: samba-cache
              mountPath: /var/cache/samba
            - name: samba-run
              mountPath: /run/samba
      volumes:
        - name: time-machine-data
          persistentVolumeClaim:
            claimName: time-machine-data
        - name: samba-config
          configMap:
            name: time-machine-config
        - name: samba-lib
          emptyDir: {}
        - name: samba-cache
          emptyDir: {}
        - name: samba-run
          emptyDir: {}
