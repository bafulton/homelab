apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: time-machine
spec:
  serviceName: time-machine
  replicas: 1  # Never go > 1
  selector:
    matchLabels:
      app.kubernetes.io/name: time-machine
  template:
    metadata:
      labels:
        app.kubernetes.io/name: time-machine
    spec:
      containers:
        - name: time-machine
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Initialize Samba directories (required before smbpasswd works)
              mkdir -p /var/lib/samba/private
              chmod 700 /var/lib/samba/private

              # Create Time Machine user
              echo "Setting up user {{ .Values.timemachine.user }}..."
              addgroup -g {{ .Values.timemachine.uid }} {{ .Values.timemachine.user }} 2>/dev/null || true
              adduser -D -u {{ .Values.timemachine.uid }} -G {{ .Values.timemachine.user }} -h /opt/time-machine {{ .Values.timemachine.user }} 2>/dev/null || true
              chown {{ .Values.timemachine.uid }}:{{ .Values.timemachine.uid }} /opt/time-machine
              chmod 755 /opt/time-machine
              echo -e "${TM_PASSWORD}\n${TM_PASSWORD}" | smbpasswd -a -s {{ .Values.timemachine.user }}

              # Copy quota.plist to data directory (per-machine quota enforcement)
              cp /etc/timemachine/quota.plist /opt/time-machine/.com.apple.TimeMachine.quota.plist
              chown {{ .Values.timemachine.uid }}:{{ .Values.timemachine.uid }} /opt/time-machine/.com.apple.TimeMachine.quota.plist

              echo "User created, starting Samba..."
              exec /entrypoint.sh smbd -F --no-process-group
          env:
            - name: TM_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: time-machine-credentials
                  key: password
            # Use our custom smb.conf and pre-created users
            - name: CUSTOM_SMB_CONF
              value: "true"
            - name: CUSTOM_USER
              value: "true"
            # mDNS/Bonjour settings
            - name: MIMIC_MODEL
              value: "TimeCapsule8,119"
            - name: ADVERTISED_HOSTNAME
              value: "timemachine"
            # General settings
            - name: DEBUG_LEVEL
              value: "1"
            - name: SMB_PORT
              value: "445"
            - name: WORKGROUP
              value: "WORKGROUP"
          ports:
            # NetBIOS ports (for discovery)
            - name: netbios-ns
              containerPort: 137
              protocol: UDP
            - name: netbios-dgm
              containerPort: 138
              protocol: UDP
            - name: netbios-ssn
              containerPort: 139
              protocol: TCP
            # SMB port
            - name: smb
              containerPort: 445
              protocol: TCP
          volumeMounts:
            - name: time-machine-data
              mountPath: /opt/time-machine
            - name: samba-config
              mountPath: /etc/samba/smb.conf
              subPath: smb.conf
            - name: quota-config
              mountPath: /etc/timemachine/quota.plist
              subPath: quota.plist
            - name: samba-lib
              mountPath: /var/lib/samba
            - name: samba-cache
              mountPath: /var/cache/samba
            - name: samba-run
              mountPath: /run/samba
      volumes:
        - name: time-machine-data
          persistentVolumeClaim:
            claimName: time-machine-data
        - name: samba-config
          configMap:
            name: time-machine-config
            items:
              - key: smb.conf
                path: smb.conf
        - name: quota-config
          configMap:
            name: time-machine-config
            items:
              - key: quota.plist
                path: quota.plist
        - name: samba-lib
          emptyDir: {}
        - name: samba-cache
          emptyDir: {}
        - name: samba-run
          emptyDir: {}
