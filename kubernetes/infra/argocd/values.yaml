namespace: argocd

# Disable pruning - if manifest generation fails, we don't want ArgoCD to delete itself
# SSA required - ArgoCD CRDs exceed 262KB annotation limit for client-side apply
syncPolicy:
  prune: false
  serverSideApply: true

# ArgoCD Vault Plugin - injects secrets from K8s Secrets
avp:
  enabled: true
  version: v1.18.1

tailscale-ingress:
  enabled: true
  ingresses:
    - name: tailscale
      hostname: argocd
      service:
        name: argocd-server
    - name: webhook
      hostname: argocd-webhook
      service:
        name: argocd-server
      funnel:
        enabled: true
        path: /api/webhook

# Bitwarden secrets pulled via ExternalSecret
bitwarden-secret:
  secrets:
    - name: argocd-github-webhook
      creationPolicy: Merge
      target:
        name: argocd-secret
      data:
        webhook.github.secret: "1386d7aa-4c3c-4e6e-ac7f-b3c70119021a"

argo-cd:
  # A complete list of values can be found here:
  # https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/values.yaml

  configs:
    secret:
      createSecret: false

    params:
      # Disable TLS on ArgoCD server - safe because it's behind Tailscale Ingress
      # which provides HTTPS termination. Do not expose directly to internet.
      server.insecure: true

  applicationSet:
    enabled: true

  # Expose metrics for Prometheus scraping (annotations on pods for discovery)
  controller:
    metrics:
      enabled: true
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8082"

  server:
    metrics:
      enabled: true
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8083"

  repoServer:
    metrics:
      enabled: true
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8084"

    # AVP sidecar plugin
    initContainers:
      - name: download-avp
        image: alpine:3.21
        command: [sh, -c]
        args:
          - |
            wget -qO /custom-tools/argocd-vault-plugin \
              https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v1.18.1/argocd-vault-plugin_1.18.1_linux_amd64 && \
            chmod +x /custom-tools/argocd-vault-plugin
        volumeMounts:
          - name: custom-tools
            mountPath: /custom-tools

    extraContainers:
      - name: avp-helm
        command: [/var/run/argocd/argocd-cmp-server]
        image: quay.io/argoproj/argocd:v3.2.3
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
        env:
          # Use Kubernetes Secret backend (secrets synced from Bitwarden via ESO)
          - name: AVP_TYPE
            value: kubernetessecret
        volumeMounts:
          - name: var-files
            mountPath: /var/run/argocd
          - name: plugins
            mountPath: /home/argocd/cmp-server/plugins
          - name: cmp-plugin
            mountPath: /home/argocd/cmp-server/config/plugin.yaml
            subPath: avp-helm.yaml
          - name: custom-tools
            mountPath: /usr/local/bin/argocd-vault-plugin
            subPath: argocd-vault-plugin
          - name: cmp-tmp
            mountPath: /tmp

    volumes:
      - name: custom-tools
        emptyDir: {}
      - name: cmp-plugin
        configMap:
          name: argocd-vault-plugin-cmp
      - name: cmp-tmp
        emptyDir: {}
