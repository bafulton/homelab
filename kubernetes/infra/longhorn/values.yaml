namespace: longhorn

# Ignore preserveUnknownFields on CRDs (per Longhorn ArgoCD docs)
# https://longhorn.io/docs/1.7.2/deploy/install/install-with-argocd/
ignoreDifferences:
  - group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    jsonPointers: ["/spec/preserveUnknownFields"]

# Node-specific disk configuration
# Each disk is tagged for use with specific StorageClasses
nodeConfig:
  nodes:
    - name: beelink
      allowScheduling: true
      disks:
        # eMMC drive (Talos EPHEMERAL partition) - for ClickHouse/etc.
        emmc-disk:
          path: /var/lib/longhorn
          storageReserved: 16106127360  # 15GB reserved for OS
          tags: ["emmc"]
        # NVMe SSD - for Time Machine backups
        nvme-disk:
          path: /var/mnt/nvme
          storageReserved: 0
          tags: ["nvme"]
        # USB Passport drive - for Jellyfin media (replicated to rpi5)
        usb-disk:
          path: /var/mnt/usb
          storageReserved: 0
          tags: ["usb"]

    - name: rpi5
      allowScheduling: true
      disks:
        # USB drive - for Jellyfin media replication
        usb-disk:
          path: /var/mnt/usb
          storageReserved: 0
          tags: ["usb"]

storageClasses:
  # eMMC - for ClickHouse and other workloads
  # Single replica (only one eMMC drive), no data locality since there's only one disk
  - name: longhorn-emmc
    diskSelector: emmc
    replicas: 1
    dataLocality: disabled

  # NVMe - for Time Machine backups
  # Single replica (only one NVMe drive), no data locality since there's only one disk
  - name: longhorn-nvme
    diskSelector: nvme
    replicas: 1
    dataLocality: disabled

  # USB - for Jellyfin media library
  # Replicated across beelink and rpi5 USB drives, no data locality to avoid orphaned replicas
  - name: longhorn-usb
    diskSelector: usb
    replicas: 2
    dataLocality: disabled

longhorn:
  # Talos-specific configuration
  # Docs: https://longhorn.io/docs/1.10.1/advanced-resources/os-distro-specific/talos-linux-support/

  # Disable default "longhorn" StorageClass - we use our own tagged classes
  persistence:
    defaultClass: false

  # Annotations for Longhorn Manager DaemonSet Pods (enables Prometheus scraping)
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9500"

  # Disable pre-upgrade checker - incompatible with ArgoCD
  # https://github.com/longhorn/longhorn/issues/8707
  preUpgradeChecker:
    jobEnabled: false

  defaultSettings:
    # Data path for Talos (matches kubelet extraMount)
    defaultDataPath: /var/lib/longhorn

  # Disable default pod security policies (deprecated in k8s 1.25+)
  enablePSP: false

gateway-route:
  routes:
    - name: dashboard
      hostnames:
        - longhorn.catfish-mountain.com
      service:
        name: longhorn-frontend
        port: 80
