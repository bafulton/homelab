# Jellyfin Media Server
# Self-hosted media streaming with Intel QuickSync hardware transcoding
#
# Access:
#   - Public/LAN: https://media.fultonhuffman.com or http://media.local (via Gateway API)
#   - Remote (alternative): https://jellyfin.catfish-mountain.ts.net (via Tailscale)

namespace: jellyfin

# Gateway API HTTPRoute for public and LAN access
# Routes through Traefik Gateway (Cloudflare Tunnel for public, MetalLB for LAN)
gateway-route:
  routes:
    - name: public-lan
      hostnames:
        - media.fultonhuffman.com  # Public access via Cloudflare Tunnel
        - media.local              # LAN access via mDNS
      service:
        name: jellyfin
        port: 8096
      mdns:
        name: Jellyfin
        ip: 192.168.0.200

# Tailscale exposure for remote access
tailscale-ingress:
  ingresses:
    - name: tailscale
      hostname: jellyfin
      service:
        name: jellyfin
        port: 8096

# Longhorn storage - config PVC with backups, media PVC on USB drive
longhorn-storage:
  pvcs:
    - name: jellyfin-config
      size: 5Gi
      storageClass: longhorn-emmc
      backupGroup: jellyfin
    - name: jellyfin-media
      size: 1Ti
      storageClass: longhorn-usb
      # No backup group for media - too large for Longhorn snapshots
  jobs:
    - name: jellyfin-config-daily
      cron: "0 3 * * *"
      groups:
        - jellyfin
      retain: 5

# Jellyfin chart configuration
jellyfin:
  # Pin to nodes with USB storage and Intel GPU
  # GPU constraint is also enforced via gpu.intel.com/i915 resource request
  nodeSelector:
    storage.homelab/usb: "true"

  # Use existing PVCs created by longhorn-storage chart
  persistence:
    config:
      enabled: true
      existingClaim: jellyfin-config
    media:
      enabled: true
      existingClaim: jellyfin-media

  # Service configuration
  service:
    type: ClusterIP
    port: 8096

  # Request Intel GPU for hardware transcoding
  # Requires intel-device-plugins to be deployed first
  resources:
    limits:
      gpu.intel.com/i915: "1"
    requests:
      cpu: 100m
      memory: 512Mi

  # FFmpeg tuning for hardware transcoding
  # Note: env is under jellyfin.jellyfin in upstream chart structure
  jellyfin:
    env:
      - name: JELLYFIN_FFmpeg__analyzeduration
        value: "200000000"
      - name: JELLYFIN_FFmpeg__probesize
        value: "1000000000"
