# Jellyfin Media Server
# Self-hosted media streaming with Intel QuickSync hardware transcoding
#
# Access:
#   - Public: https://media.fultonhuffman.com (via Cloudflare Tunnel)
#   - LAN: http://media.local (via mDNS)

namespace: jellyfin

# Gateway API HTTPRoute for public and LAN access
# Routes through Traefik Gateway (Cloudflare Tunnel for public, MetalLB for LAN)
gateway-route:
  routes:
    - name: public-lan
      hostnames:
        - media.fultonhuffman.com  # Public access via Cloudflare Tunnel
        - media.local              # LAN access via mDNS
      service:
        name: jellyfin
        port: 8096
      mdns:
        name: Jellyfin
        ip: 192.168.0.200

# Longhorn storage - config PVC with backups, media PVC on USB drive
longhorn-storage:
  pvcs:
    - name: jellyfin-config
      size: 5Gi
      storageClass: longhorn-emmc
      backupGroup: jellyfin
    - name: jellyfin-media
      size: 1Ti
      storageClass: longhorn-usb
      # No backup group for media - too large for Longhorn snapshots
  jobs:
    - name: jellyfin-config-daily
      cron: "0 3 * * *"
      groups:
        - jellyfin
      retain: 5

# Jellyfin chart configuration
jellyfin:
  # Pin to nodes with USB storage and Intel GPU
  # GPU constraint is also enforced via gpu.intel.com/i915 resource request
  nodeSelector:
    storage.homelab/usb: "true"

  # Use existing PVCs created by longhorn-storage chart
  persistence:
    config:
      enabled: true
      existingClaim: jellyfin-config
    media:
      enabled: true
      existingClaim: jellyfin-media

  # Service configuration
  service:
    type: ClusterIP
    port: 8096

  # Request Intel GPU for hardware transcoding
  # Requires intel-device-plugins to be deployed first
  resources:
    limits:
      gpu.intel.com/i915: "1"
    requests:
      cpu: 100m
      memory: 512Mi

  # FFmpeg tuning for hardware transcoding
  # Note: env is under jellyfin.jellyfin in upstream chart structure
  jellyfin:
    env:
      - name: JELLYFIN_FFmpeg__analyzeduration
        value: "200000000"
      - name: JELLYFIN_FFmpeg__probesize
        value: "1000000000"

# SigNoz alerts - automatically synced to SigNoz via ConfigMap discovery
signoz-alerts:
  alerts:
    - name: Jellyfin Test Alert - Always Fires
      type: threshold
      description: Test alert that always fires to validate ConfigMap discovery workflow
      severity: warning
      metric: k8s.pod.cpu.usage
      op: ">"
      threshold: 0  # Will always fire since CPU usage is always > 0
      filter: k8s.namespace.name = 'jellyfin' AND k8s.pod.name LIKE 'jellyfin-%'
      groupBy:
        - k8s.pod.name
      timeAggregation: avg
      evalWindow: 1m0s
      frequency: 1m0s
