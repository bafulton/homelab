namespace: home-assistant

# Traefik IngressRoute for LAN access via mDNS (home.local)
# Routes through Traefik's MetalLB IP (192.168.0.200)
traefik-ingress:
  ingresses:
    - name: lan
      hostname: home.local
      service:
        name: home-assistant
        port: 80
      mdns:
        name: Home Assistant
        ip: 192.168.0.200
        types:
          - type: _home-assistant._tcp
          - type: _http._tcp

# Tailscale exposure for web UI
tailscale-ingress:
  ingresses:
    - name: tailscale
      hostname: home-assistant
      service:
        name: home-assistant
        port: 80

home-assistant:
  # Enable host networking for device auto-discovery (mDNS, SSDP, etc.)
  # Required for discovering Kasa, Meross, SwitchBot, and other LAN devices
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet

  # Configuration management - enables trusted_proxies for reverse proxies (Tailscale + Traefik)
  # forceInit: true merges templateConfig into configuration.yaml on every restart (GitOps-friendly)
  configuration:
    enabled: true
    forceInit: true
    trusted_proxies:
      - 10.244.0.0/16   # Kubernetes pod CIDR
      - 192.168.0.0/24  # LAN subnet (cross-node traffic with hostNetwork)
    templateConfig: |
      # Loads default set of integrations. Do not remove.
      default_config:

      # Home Assistant core configuration
      homeassistant:
        internal_url: "http://home.local"
        external_url: "https://home-assistant.catfish-mountain.ts.net"
        latitude: 36.085348151351745
        longitude: -80.25007509137713
        elevation: 268  # 880 feet in meters
        unit_system: us_customary
        time_zone: America/New_York
        # Load GitOps-managed packages from ConfigMap
        packages: !include_dir_named packages

      # HTTP configuration for reverse proxy (Tailscale)
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          {{- range .Values.configuration.trusted_proxies }}
          - {{ . }}
          {{- end }}

      # Load frontend themes from the themes folder
      frontend:
        themes: !include_dir_merge_named themes

      # Expose metrics for SigNoz via Prometheus endpoint
      # requires_auth: false allows cluster-internal scraping without a token
      prometheus:
        requires_auth: false

  # Recreate strategy required because hostNetwork: true means only one pod can bind port 8123
  deploymentStrategy: Recreate

  # Use Deployment with pre-provisioned PVC (managed by longhorn-storage chart)
  controller:
    type: Deployment

  # Use existing PVC created by longhorn-storage chart (has backup labels)
  persistence:
    enabled: true
    existingClaim: home-assistant-config

  # Service configuration
  # ClusterIP service - accessed via Traefik IngressRoute for LAN and Tailscale Ingress for remote
  service:
    type: ClusterIP
    port: 80

  # Prometheus metrics for SigNoz integration
  # The prometheus: config above enables the /api/prometheus endpoint
  # These annotations tell SigNoz to scrape it
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8123"
    prometheus.io/path: "/api/prometheus"
    # Reloader watches home-assistant-packages ConfigMap and restarts pod on changes
    reloader.stakater.com/match: "true"

  # Startup probe - allows up to 5 minutes for Home Assistant to initialize
  # Liveness/readiness probes won't run until startup probe succeeds
  startupProbe:
    httpGet:
      path: /
      port: http
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 30

  # Mount GitOps-managed packages from ConfigMap
  additionalVolumes:
    - name: packages
      configMap:
        name: home-assistant-packages

  additionalMounts:
    - name: packages
      mountPath: /config/packages
      readOnly: true

# AirCast - AirPlay bridge for Chromecast devices
# Allows streaming audio from Apple devices to Chromecast speakers
# https://github.com/1activegeek/docker-airconnect
aircast:
  enabled: true
  image:
    repository: 1activegeek/airconnect
    # renovate: datasource=docker depName=1activegeek/airconnect
    tag: "1.9.3"
    pullPolicy: IfNotPresent

# Matter Server - Controller for Matter smart home devices
# Home Assistant connects via WebSocket at ws://matter-server:5580/ws
# https://github.com/home-assistant-libs/python-matter-server
matterServer:
  enabled: true
  image:
    # Image moved from home-assistant-libs to matter-js org
    repository: ghcr.io/matter-js/python-matter-server
    # renovate: datasource=docker depName=ghcr.io/matter-js/python-matter-server
    tag: "8.1.2"
    pullPolicy: IfNotPresent
  persistence:
    storageClass: longhorn-emmc
    size: 1Gi

# Longhorn storage - PVC with backup labels and daily snapshots
longhorn-storage:
  pvcs:
    - name: home-assistant-config
      size: 5Gi
      storageClass: longhorn-emmc
      backupGroup: home-assistant
  jobs:
    - name: home-assistant-daily
      cron: "0 2 * * *"
      groups:
        - home-assistant
      retain: 5
