namespace: home-assistant

# Traefik IngressRoute for LAN access via mDNS (home.local)
# Routes through Traefik's MetalLB IP (192.168.0.200)
traefik:
  enabled: true
  hostname: home.local
  servicePort: 80

# Tailscale exposure for web UI
tailscale-ingress:
  enabled: true
  ingresses:
    - name: tailscale
      hostname: home
      service:
        name: home-assistant
        port: 80

home-assistant:
  # Enable host networking for device auto-discovery (mDNS, SSDP, etc.)
  # Required for discovering Kasa, Meross, SwitchBot, and other LAN devices
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet

  # Configuration management - enables trusted_proxies for reverse proxies (Tailscale + Traefik)
  # forceInit: true merges templateConfig into configuration.yaml on every restart (GitOps-friendly)
  configuration:
    enabled: true
    forceInit: true
    trusted_proxies:
      - 10.244.0.0/16  # Kubernetes pod CIDR (Tailscale and Traefik pods)
    templateConfig: |
      # Loads default set of integrations. Do not remove.
      default_config:

      # Home Assistant core configuration
      homeassistant:
        internal_url: "http://home.local"
        external_url: "https://home.catfish-mountain.ts.net"
        latitude: 36.085348151351745
        longitude: -80.25007509137713
        elevation: 268  # 880 feet in meters
        unit_system: us_customary
        time_zone: America/New_York

      # HTTP configuration for reverse proxy (Tailscale)
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          {{- range .Values.configuration.trusted_proxies }}
          - {{ . }}
          {{- end }}

      # Load frontend themes from the themes folder
      frontend:
        themes: !include_dir_merge_named themes

      # Expose metrics for SigNoz via Prometheus endpoint
      # requires_auth: false allows cluster-internal scraping without a token
      prometheus:
        requires_auth: false

  # Use StatefulSet for stable identity
  controller:
    type: StatefulSet

  # Persistent storage for configuration
  persistence:
    enabled: true
    storageClass: longhorn-emmc
    size: 10Gi
    accessMode: ReadWriteOnce

  # Service configuration
  # ClusterIP service - accessed via Traefik IngressRoute for LAN and Tailscale Ingress for remote
  service:
    type: ClusterIP
    port: 80

  # Prometheus metrics for SigNoz integration
  # The prometheus: config above enables the /api/prometheus endpoint
  # These annotations tell SigNoz to scrape it
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8123"
    prometheus.io/path: "/api/prometheus"

# AirCast - AirPlay bridge for Chromecast devices
# Allows streaming audio from Apple devices to Chromecast speakers
# https://github.com/1activegeek/docker-airconnect
aircast:
  enabled: true
  image:
    repository: 1activegeek/airconnect
    # renovate: datasource=docker depName=1activegeek/airconnect
    tag: "1.9.3"
    pullPolicy: IfNotPresent

# Matter Server - Controller for Matter smart home devices
# Home Assistant connects via WebSocket at ws://localhost:5580/ws
# (localhost works because both HA and Matter Server use hostNetwork)
# https://github.com/home-assistant-libs/python-matter-server
matterServer:
  enabled: true
  image:
    # Image moved from home-assistant-libs to matter-js org
    repository: ghcr.io/matter-js/python-matter-server
    # renovate: datasource=docker depName=ghcr.io/matter-js/python-matter-server
    tag: "8.1.2"
    pullPolicy: IfNotPresent
  persistence:
    storageClass: longhorn-emmc
    size: 1Gi

# Longhorn storage - PVC with backup labels for migration
# Phase 2: Creates new PVC, HA continues using old StatefulSet PVC
# Phase 4: Switch to Deployment with existingClaim: home-assistant-config
longhorn-storage:
  pvcs:
    - name: home-assistant-config
      size: 10Gi
      storageClass: longhorn-emmc
      backupGroup: home-assistant
  jobs:
    - name: home-assistant-daily
      cron: "0 2 * * *"
      groups:
        - home-assistant
      retain: 5
