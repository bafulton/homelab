# Cloudflare Terraform Configuration

This Terraform configuration manages Cloudflare Tunnel and DNS records for routing public traffic to the homelab Kubernetes cluster.

## What It Manages

- **Cloudflare Tunnel**: Creates the "homelab" tunnel that connects Cloudflare to the Traefik ingress in the Kubernetes cluster
- **DNS Records**: Configures wildcard and specific subdomain records that route to the tunnel
- **Tunnel Configuration**: Defines ingress rules that control which hostnames are allowed through the tunnel

## Manual Workflow

Currently, this Terraform configuration is applied manually:

1. Get the Cloudflare API token from Bitwarden (stored in BSM)
2. Export it as an environment variable:
   ```bash
   export CLOUDFLARE_API_TOKEN="your-token-here"
   ```
3. Run Terraform:
   ```bash
   cd terraform/cloudflare
   terraform init    # First time only
   terraform plan    # Review changes
   terraform apply   # Apply changes
   ```

The tunnel token output is used to configure the `cloudflared` deployment in `kubernetes/infra/cloudflared/`.

## Domain Configuration

Domains are configured in `variables.tf` with two key settings:

### `wildcard_public`

- `true`: Creates wildcard DNS (`*.domain.com`) routing all subdomains to the tunnel - used for fully public domains
- `false`: No wildcard DNS - domain is private (Tailscale Split DNS only) with specific public exceptions

### `public_subdomains`

A list of specific subdomains that should be publicly accessible, even on private domains.

### Example Configuration

```hcl
variable "domains" {
  default = {
    "fultonhuffman-com" = {
      domain            = "fultonhuffman.com"
      wildcard_public   = true    # Fully public
      public_subdomains = []
    }
    "catfish-mountain-com" = {
      domain            = "catfish-mountain.com"
      wildcard_public   = false   # Private (Tailscale only)
      public_subdomains = [
        "argocd-webhook"          # Exception: public webhook
      ]
    }
  }
}
```

## Domain Strategy

The configuration implements the homelab's domain strategy:

- `*.fultonhuffman.com`, `*.yak-shave.com`, `*.benfulton.me` - Fully public domains (wildcard routing)
- `*.catfish-mountain.com` - Private infrastructure domain (Tailscale Split DNS)
  - Only accessible via Tailscale when connected to the tailnet
  - Specific subdomains (like `argocd-webhook`) are explicitly made public for external services

## How DNS and Tunnel Work Together

1. **DNS Records** (`dns.tf`): Create CNAME records pointing to the Cloudflare Tunnel
   - Wildcard records (`*.domain.com`) for public domains
   - Specific subdomain records for public exceptions on private domains

2. **Tunnel Configuration** (`tunnel_config.tf`): Define ingress rules controlling what the tunnel accepts
   - Public subdomains (matched first)
   - Root domains for wildcard public domains
   - Wildcard routes for wildcard public domains
   - Catch-all 404 for everything else

3. **Traffic Flow**:
   ```
   User → Cloudflare DNS → Cloudflare Tunnel → Traefik (in cluster) → Service
   ```

## Adding a New Domain

1. Add the domain to your Cloudflare account (must be done manually in Cloudflare dashboard)
2. Add the domain configuration to `variables.tf`:
   ```hcl
   "new-domain-com" = {
     domain            = "new-domain.com"
     wildcard_public   = true   # or false for private
     public_subdomains = []
   }
   ```
3. Run `terraform plan` and `terraform apply`

## Adding a Public Subdomain to a Private Domain

To expose a specific subdomain on `catfish-mountain.com` (or any private domain):

1. Edit `variables.tf` and add the subdomain to `public_subdomains`:
   ```hcl
   "catfish-mountain-com" = {
     domain            = "catfish-mountain.com"
     wildcard_public   = false
     public_subdomains = [
       "argocd-webhook",
       "new-webhook"      # Add this
     ]
   }
   ```
2. Run `terraform apply`

## Files

- `main.tf` - Provider configuration and tunnel resource
- `variables.tf` - Domain configuration (single source of truth)
- `zones.tf` - Zone data lookups
- `dns.tf` - DNS record creation (wildcard and specific subdomains)
- `tunnel_config.tf` - Tunnel ingress rules (what traffic is allowed)
- `.terraform.lock.hcl` - Provider version lock file (committed)
- `terraform.tfstate*` - State files (gitignored)

## Important Notes

- The tunnel secret is randomly generated by Terraform and stored in state
- The tunnel token output is sensitive and used in the Kubernetes deployment
- Cloudflare handles TLS termination for public domains (Universal SSL)
- Private domain TLS (*.catfish-mountain.com) is handled by Let's Encrypt in the cluster
- The tunnel always routes to `traefik.traefik.svc.cluster.local:80` - Traefik handles routing to services
