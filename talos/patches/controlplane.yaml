# Talos Control Plane Patch
#
# This patch is applied to the control plane node.
# Requires environment variables:
#   - TS_AUTHKEY: Tailscale auth key
#   - HOSTNAME: Node hostname
#   - TAILNET_NAME: Tailscale tailnet name (without .ts.net)
#
# Processed by generate-configs.sh

machine:
  network:
    hostname: ${HOSTNAME}
    nameservers:
      - 100.100.100.100  # Tailscale MagicDNS resolver

  # Configure kubelet to prefer Tailscale IPs
  kubelet:
    nodeIP:
      validSubnets:
        - 100.64.0.0/10  # Tailscale CGNAT range

  # Tailscale extension configuration
  files:
    - content: |
        TS_AUTHKEY=${TS_AUTHKEY}
        TS_HOSTNAME=${HOSTNAME}
        TS_EXTRA_ARGS=--accept-dns=true --accept-routes --ssh
        TS_STATE_DIR=/var/lib/tailscale
      path: /var/etc/tailscale/auth.env
      permissions: 0o600

  # Kernel modules for Longhorn (comment out if not using)
  kernel:
    modules:
      - name: iscsi_tcp

  # Sysctls for container networking
  sysctls:
    net.core.somaxconn: "65535"
    net.core.netdev_max_backlog: "4096"

cluster:
  # Allow workloads on the control plane
  allowSchedulingOnControlPlanes: true

  # API server configuration
  apiServer:
    certSANs:
      - ${HOSTNAME}.${TAILNET_NAME}.ts.net
      - ${HOSTNAME}
      - 127.0.0.1

  # Controller manager - no cloud provider
  controllerManager:
    extraArgs:
      cloud-provider: external  # Disable in-tree cloud provider

  # Use Flannel CNI (Talos default) - or set to 'none' if installing Cilium
  network:
    cni:
      name: flannel
