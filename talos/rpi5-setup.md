# Raspberry Pi 5 Talos Setup Guide

This document covers the RPi5 node setup, including why it uses community images, how to build custom images with extensions, and the migration path to official Talos support.

## Current State (January 2026)

The RPi5 node runs **talos-rpi5 community images (v1.11.5)** because official Talos lacks proper RPi5 support. The official Talos kernel is missing RP1 chip drivers required for ethernet and USB on RPi5.

| Component | Value |
|-----------|-------|
| Talos Version | v1.11.5-1-gfe840f161 (talos-rpi5) |
| Kubernetes | v1.34.1 |
| Installer Image | ghcr.io/talos-rpi5/installer:v1.11.5 |
| Config File | `clusterconfig/homelab-rpi5-manual.yaml` |

### Installed Extensions

| Extension | Version | Status |
|-----------|---------|--------|
| iscsi-tools | v0.2.0 | Running (for Longhorn) |
| tailscale | 1.88.1 | Running |
| util-linux-tools | 2.41.1 | Installed |

### Storage Configuration

| Mount | Device | Filesystem | Purpose |
|-------|--------|------------|---------|
| /var/lib/longhorn | SD card | XFS | Longhorn default disk |
| /var/mnt/usb | /dev/sda | XFS | USB disk (~2TB) |

### Known Limitations

- **Cannot use `talosctl upgrade`** - efivarfs limitation on RPi5
- **Must rebuild and re-flash** metal image to change extensions
- **Manual config management** - using `homelab-rpi5-manual.yaml` until official support

> **Note:** `talconfig.yaml` is already configured for official Talos support. When RPi5 support lands, simply regenerate configs and apply - no talconfig changes needed.

**Tracking issues:**
- https://github.com/siderolabs/talos/issues/7978
- https://github.com/siderolabs/sbc-raspberrypi/issues/23
- https://github.com/siderolabs/talos/discussions/7821

---

## Manual Configuration

Since the RPi5 can't use the standard talhelper workflow, the config is maintained manually at:

```
talos/clusterconfig/homelab-rpi5-manual.yaml
```

This file is **not** generated by `generate-configs.sh` and must be updated manually. Key differences from the talhelper-generated config:

| Setting | Manual Config | talhelper Config |
|---------|---------------|------------------|
| kubelet image | v1.34.1 | v1.35.0 |
| install image | ghcr.io/talos-rpi5/installer:v1.11.5 | factory.talos.dev/... |
| hostname | Under machine.network.hostname | HostnameConfig document |
| grubUseUKICmdline | Not present (v1.11.5 incompatible) | Present |

### Applying Config Changes

```bash
talosctl apply-config \
  --nodes rpi5.catfish-mountain.ts.net \
  --file talos/clusterconfig/homelab-rpi5-manual.yaml
```

**Important:** Always update `homelab-rpi5-manual.yaml` after making changes so the file reflects the running config.

---

## Tailscale Extension Configuration

The Tailscale extension is configured via `ExtensionServiceConfig` as a **separate YAML document** (not under machine.pods):

```yaml
# Main config document
version: v1alpha1
machine:
  # ... machine config ...
cluster:
  # ... cluster config ...
---
# Separate document for extension config
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: tailscale
environment:
  - TS_AUTHKEY=tskey-auth-XXXX
  - TS_EXTRA_ARGS=--accept-dns=true --accept-routes --ssh
```

**Notes:**
- Use an **auth key** (tskey-auth-...), not an OAuth client secret
- The `---` separator is required - this must be a separate YAML document
- Auth keys can be created at https://login.tailscale.com/admin/settings/keys

---

## Building Custom Metal Images

Extensions cannot be added via `talosctl upgrade` due to efivarfs limitations:

```
Firmware does not support SetVariableRT. Can not remount with rw
Error: failed to install bootloader: failed to create efivarfs reader/writer: invalid argument
```

The solution is to build a fresh metal image with extensions baked in.

### Build on RPi5 Itself (Recommended)

Run the imager as a privileged pod on the rpi5 node. This provides:
- Native arm64 execution (no cross-compilation)
- Access to loopback devices (doesn't work in Docker Desktop on macOS)

#### Step 1: Deploy Builder Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: talos-image-builder
  namespace: longhorn  # or any namespace with privileged access
spec:
  restartPolicy: Never
  nodeSelector:
    kubernetes.io/hostname: rpi5
  initContainers:
  - name: builder
    image: ghcr.io/talos-rpi5/imager:v1.11.5-1-gfe840f161
    args:
    - metal
    - --arch=arm64
    - --overlay-image=ghcr.io/talos-rpi5/sbc-raspberrypi5:7d04484-v1.11.0-1-g34f19c2
    - --overlay-name=rpi5
    - --system-extension-image=ghcr.io/siderolabs/iscsi-tools:v0.2.0
    - --system-extension-image=ghcr.io/siderolabs/tailscale:1.88.1
    - --system-extension-image=ghcr.io/siderolabs/util-linux-tools:2.41.1
    - --output-kind=image
    securityContext:
      privileged: true
    volumeMounts:
    - name: dev
      mountPath: /dev
    - name: output
      mountPath: /out
  containers:
  - name: server
    image: python:3.12-alpine
    command: ["python3", "-m", "http.server", "8080", "--directory", "/out"]
    ports:
    - containerPort: 8080
    volumeMounts:
    - name: output
      mountPath: /out
  volumes:
  - name: dev
    hostPath:
      path: /dev
  - name: output
    emptyDir:
      sizeLimit: 4Gi
```

#### Step 2: Download the Image

```bash
# Watch build progress
kubectl logs talos-image-builder -n longhorn -c builder -f

# Download via port-forward
kubectl port-forward pod/talos-image-builder -n longhorn 8080:8080 &
curl -o metal-arm64-rpi5-ext.raw.zst http://localhost:8080/metal-arm64.raw.zst
kill %1

# Clean up
kubectl delete pod talos-image-builder -n longhorn
```

#### Step 3: Flash and Configure

```bash
# Decompress
zstd -d metal-arm64-rpi5-ext.raw.zst

# Flash to SD card (replace diskN with your SD card)
sudo diskutil unmountDisk /dev/diskN
sudo dd if=metal-arm64-rpi5-ext.raw of=/dev/rdiskN bs=4M status=progress

# Boot rpi5, then apply config
talosctl apply-config --insecure --nodes 192.168.0.17 \
  --file talos/clusterconfig/homelab-rpi5-manual.yaml
```

#### Step 4: Post-Flash Cleanup

```bash
# Restart Longhorn pods if they're in crashloop
kubectl delete pods -n longhorn --field-selector spec.nodeName=rpi5

# Verify extensions
talosctl get extensions --nodes rpi5.catfish-mountain.ts.net
```

### What Doesn't Work

| Method | Error |
|--------|-------|
| `talosctl upgrade` | efivarfs read-only error |
| Docker Desktop on macOS | Loopback device errors |
| Cross-arch build (amd64â†’arm64) | exec format error |

---

## USB Disk Setup

The USB disk is configured in the machine config:

```yaml
machine:
  disks:
    - device: /dev/sda
      partitions:
        - mountpoint: /var/mnt/usb
  kubelet:
    extraMounts:
      - destination: /var/mnt/usb
        type: bind
        source: /var/mnt/usb
        options:
          - bind
          - rshared
          - rw
```

### Wiping an Existing Disk

If the USB disk has an existing filesystem (e.g., APFS from macOS), Talos will refuse to format it. Wipe it first:

```bash
talosctl wipe disk sda --nodes rpi5.catfish-mountain.ts.net
talosctl wipe disk sda1 --nodes rpi5.catfish-mountain.ts.net  # if partition exists
```

Then apply config and reboot for Talos to format the disk.

---

## Troubleshooting

### Kubelet Not Starting - CA Certificate Error

```
error adding CA to root pool: %!w(<nil>)
```

This indicates a corrupted cluster CA certificate. Compare your config's `cluster.ca.crt` with the talhelper-generated config to ensure it's correct. The certificate should decode to show `O=kubernetes` for both subject and issuer:

```bash
echo "<base64-cert>" | base64 -d | openssl x509 -noout -subject -issuer
# Should show:
# subject=O=kubernetes
# issuer=O=kubernetes
```

### ExtensionServiceConfig Lost After Reboot

The `talosctl patch` command doesn't preserve separate YAML documents. Always apply the full config file with all documents:

```bash
talosctl apply-config --nodes rpi5.catfish-mountain.ts.net \
  --file talos/clusterconfig/homelab-rpi5-manual.yaml
```

### Longhorn Pods Crashlooping

After adding iscsi-tools extension, restart Longhorn pods:

```bash
kubectl delete pods -n longhorn --field-selector spec.nodeName=rpi5
```

---

## Migration to Official Talos

### When to Migrate

Watch for:
1. Talos release notes mentioning "Raspberry Pi 5" support
2. `sbc-raspberrypi` overlay updates with RPi5 device trees
3. Kernel 6.19+ in Talos (has full RPi5 device tree support)

Test by checking if Image Factory produces working RPi5 images.

### Migration Steps

#### 1. Verify Official Support Works

```bash
# Download test image with the schematic (same as rpi3)
curl -LO "https://factory.talos.dev/image/59a07420a7e77b52dce55311856a16b377e2f9ef61762e8873de65a945954d91/v1.X.X/metal-arm64.raw.zst"

# Flash to spare SD card and test boot + ethernet
```

#### 2. Regenerate and Apply

`talconfig.yaml` is already configured for official support. Just regenerate:

```bash
cd talos
./generate-configs.sh

# Flash the new image to SD card, then apply config
talosctl apply-config --insecure --nodes 192.168.0.17 \
  --file talos/clusterconfig/homelab-rpi5.yaml

# Or if talosctl upgrade works on official images:
talosctl upgrade \
  --nodes rpi5.catfish-mountain.ts.net \
  --image factory.talos.dev/installer/59a07420a7e77b52dce55311856a16b377e2f9ef61762e8873de65a945954d91:v1.X.X
```

#### 3. Clean Up

Once on official images, you can:
- Delete `homelab-rpi5-manual.yaml`
- Delete this document (`rpi5-setup.md`)

---

## Reference

### Image References

| Component | Image |
|-----------|-------|
| Imager | ghcr.io/talos-rpi5/imager:v1.11.5-1-gfe840f161 |
| Installer | ghcr.io/talos-rpi5/installer:v1.11.5 |
| Overlay | ghcr.io/talos-rpi5/sbc-raspberrypi5:7d04484-v1.11.0-1-g34f19c2 |

### Extension Versions (for Talos v1.11.5)

| Extension | Version |
|-----------|---------|
| iscsi-tools | v0.2.0 |
| tailscale | 1.88.1 |
| util-linux-tools | 2.41.1 |

### Links

- talos-rpi5 project: https://github.com/talos-rpi5
- RPi5 support discussion: https://github.com/siderolabs/talos/discussions/7821
- Official RPi5 overlay issue: https://github.com/siderolabs/sbc-raspberrypi/issues/23
- Installation guide: https://rcwz.pl/2025-10-04-installing-talos-on-raspberry-pi-5/
