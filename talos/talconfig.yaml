# Talos Cluster Configuration
#
# This file defines the entire cluster configuration for Talhelper.
# Secrets are provided via environment variables (see .env.example).
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: talhelper genconfig
#   3. Apply configs to nodes
#
# Docs: https://budimanjojo.github.io/talhelper/latest/

clusterName: homelab
talosVersion: v1.12.2
kubernetesVersion: v1.35.0
endpoint: https://beelink.catfish-mountain.ts.net:6443

allowSchedulingOnControlPlanes: true

cniConfig:
  name: flannel

# ------------------------------------------------------------------------------
# Nodes
# ------------------------------------------------------------------------------
# NOTE: Update the tailnet name below if you fork this repo
nodes:
  - hostname: beelink
    controlPlane: true
    ipAddress: beelink.catfish-mountain.ts.net
    installDisk: /dev/mmcblk0  # eMMC, not the NVMe SSD
    # Image Factory schematic with extensions: intel-ucode, iscsi-tools, tailscale, util-linux-tools, i915
    # Note: Don't include version tag - talhelper appends talosVersion automatically
    talosImageURL: factory.talos.dev/installer/445a99db4002e6127e7f6e2a96377ac2c06d0de52f7a186b5536c0ac2f2a2ece
    nodeLabels:
      storage.homelab/emmc: "true"
      storage.homelab/nvme: "true"
      storage.homelab/usb: "true"
    patches:
      # Mount NVME and USB drives for Longhorn storage
      - |-
        machine:
          disks:
            - device: /dev/nvme0n1
              partitions:
                - mountpoint: /var/mnt/nvme
            - device: /dev/sda
              partitions:
                - mountpoint: /var/mnt/usb

      # Kubelet extraMounts for Longhorn to access NVME and USB drives
      - |-
        machine:
          kubelet:
            extraMounts:
              - destination: /var/mnt/nvme
                type: bind
                source: /var/mnt/nvme
                options:
                  - bind
                  - rshared
                  - rw
              - destination: /var/mnt/usb
                type: bind
                source: /var/mnt/usb
                options:
                  - bind
                  - rshared
                  - rw

  - hostname: rpi3
    controlPlane: false
    ipAddress: rpi3.catfish-mountain.ts.net
    installDisk: /dev/mmcblk0  # SD card
    # Image Factory schematic with extensions: iscsi-tools, tailscale, util-linux-tools
    # Note: Don't include version tag - talhelper appends talosVersion automatically
    talosImageURL: factory.talos.dev/installer/59a07420a7e77b52dce55311856a16b377e2f9ef61762e8873de65a945954d91

  - hostname: rpi5
    controlPlane: false
    ipAddress: rpi5.catfish-mountain.ts.net
    installDisk: /dev/mmcblk0  # SD card
    # Image Factory schematic with extensions: iscsi-tools, tailscale, util-linux-tools
    # Same schematic as rpi3 (both are arm64 SBCs with same extensions)
    # NOTE: Official Talos doesn't support RPi5 yet - using manual config for now
    # See talos/rpi5-setup.md for current workaround and migration plan
    talosImageURL: factory.talos.dev/installer/59a07420a7e77b52dce55311856a16b377e2f9ef61762e8873de65a945954d91
    nodeLabels:
      storage.homelab/usb: "true"
    patches:
      # RPi5-specific cert SANs for Tailscale access
      - |-
        machine:
          certSANs:
            - rpi5.catfish-mountain.ts.net

      # Mount USB drive for Longhorn storage
      - |-
        machine:
          disks:
            - device: /dev/sda
              partitions:
                - mountpoint: /var/mnt/usb

      # Kubelet extraMount for USB drive (Longhorn access)
      - |-
        machine:
          kubelet:
            extraMounts:
              - destination: /var/mnt/usb
                type: bind
                source: /var/mnt/usb
                options:
                  - bind
                  - rshared
                  - rw

# ------------------------------------------------------------------------------
# Patches - Applied to ALL nodes
# ------------------------------------------------------------------------------
patches:
  # Talos API certificate SANs for Tailscale access
  - |-
    machine:
      certSANs:
        - beelink.catfish-mountain.ts.net

  # Networking: Use Tailscale MagicDNS with fallback to Google DNS
  - |-
    machine:
      network:
        nameservers:
          - 100.100.100.100
          - 8.8.8.8

  # Disable forwarding kube-dns to host DNS proxy
  # The host DNS proxy (169.254.116.108) is unreachable from pods
  # This makes CoreDNS resolve external domains directly
  - |-
    machine:
      features:
        hostDNS:
          enabled: true
          forwardKubeDNSToHost: false

  # Kubelet: Use LAN IPs for node addresses (enables MetalLB L2 mode)
  # Tailscale is still used for API access via the endpoint
  - |-
    machine:
      kubelet:
        nodeIP:
          validSubnets:
            - 192.168.0.0/24
            - 100.64.0.0/10

  # Tailscale extension configuration via ExtensionServiceConfig
  - |-
    apiVersion: v1alpha1
    kind: ExtensionServiceConfig
    name: tailscale
    environment:
      - TS_AUTHKEY={{ env "TS_AUTHKEY" }}
      - TS_EXTRA_ARGS=--accept-dns=true --accept-routes --ssh

  # Kernel modules for Longhorn storage
  - |-
    machine:
      kernel:
        modules:
          - name: iscsi_tcp

  # Kubelet mount for Longhorn data path (required for Talos v1.10+)
  - |-
    machine:
      kubelet:
        extraMounts:
          - destination: /var/lib/longhorn
            type: bind
            source: /var/lib/longhorn
            options:
              - bind
              - rshared
              - rw

  # Sysctls for container networking
  - |-
    machine:
      sysctls:
        net.core.somaxconn: "65535"
        net.core.netdev_max_backlog: "4096"

# ------------------------------------------------------------------------------
# Control Plane Patches
# ------------------------------------------------------------------------------
controlPlane:
  patches:
    # API server certificate SANs for Tailscale access
    - |-
      cluster:
        apiServer:
          certSANs:
            - beelink.catfish-mountain.ts.net
            - beelink
            - 127.0.0.1

    # Disable in-tree cloud provider
    - |-
      cluster:
        controllerManager:
          extraArgs:
            cloud-provider: external

    # Enable Talos API access from Kubernetes for tuppr upgrade controller
    - |-
      machine:
        features:
          kubernetesTalosAPIAccess:
            enabled: true
            allowedRoles:
              - os:admin
            allowedKubernetesNamespaces:
              - tuppr
