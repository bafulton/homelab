name: Talos-Kubernetes Compatibility Check

on:
  pull_request:
    paths:
      - 'talos/talconfig.yaml'
      - 'kubernetes/infra/tuppr/templates/talos-upgrade.yaml'
      - 'kubernetes/infra/tuppr/templates/kubernetes-upgrade.yaml'

jobs:
  check-compatibility:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract versions from talconfig.yaml
        id: versions
        run: |
          TALOS_VERSION=$(grep 'talosVersion:' talos/talconfig.yaml | awk '{print $2}')
          K8S_VERSION=$(grep 'kubernetesVersion:' talos/talconfig.yaml | awk '{print $2}')

          # Extract major.minor for comparison
          TALOS_MINOR=$(echo "$TALOS_VERSION" | sed 's/v\([0-9]*\.[0-9]*\).*/\1/')
          K8S_MINOR=$(echo "$K8S_VERSION" | sed 's/v\([0-9]*\.\)\([0-9]*\).*/\2/')

          echo "talos_version=$TALOS_VERSION" >> $GITHUB_OUTPUT
          echo "k8s_version=$K8S_VERSION" >> $GITHUB_OUTPUT
          echo "talos_minor=$TALOS_MINOR" >> $GITHUB_OUTPUT
          echo "k8s_minor=$K8S_MINOR" >> $GITHUB_OUTPUT

      - name: Check Talos-Kubernetes compatibility
        env:
          TALOS_VERSION: ${{ steps.versions.outputs.talos_version }}
          K8S_VERSION: ${{ steps.versions.outputs.k8s_version }}
          TALOS_MINOR: ${{ steps.versions.outputs.talos_minor }}
          K8S_MINOR: ${{ steps.versions.outputs.k8s_minor }}
        run: |
          echo "Checking compatibility:"
          echo "  Talos: $TALOS_VERSION (minor: $TALOS_MINOR)"
          echo "  Kubernetes: $K8S_VERSION (minor: $K8S_MINOR)"

          # Talos version to max Kubernetes minor version mapping
          # Each Talos version supports ~6 Kubernetes minor versions
          # Update this mapping when new Talos versions are released
          declare -A TALOS_K8S_MAX=(
            ["1.10"]="33"
            ["1.11"]="34"
            ["1.12"]="35"
            ["1.13"]="36"
            ["1.14"]="37"
          )

          declare -A TALOS_K8S_MIN=(
            ["1.10"]="28"
            ["1.11"]="29"
            ["1.12"]="30"
            ["1.13"]="31"
            ["1.14"]="32"
          )

          MAX_K8S="${TALOS_K8S_MAX[$TALOS_MINOR]}"
          MIN_K8S="${TALOS_K8S_MIN[$TALOS_MINOR]}"

          if [ -z "$MAX_K8S" ]; then
            echo "⚠️  Warning: Unknown Talos version $TALOS_MINOR - please update the compatibility matrix in this workflow"
            echo "Assuming compatibility for now..."
            exit 0
          fi

          if [ "$K8S_MINOR" -gt "$MAX_K8S" ]; then
            echo "❌ Error: Kubernetes $K8S_VERSION is too new for Talos $TALOS_VERSION"
            echo "   Talos $TALOS_MINOR supports Kubernetes 1.$MIN_K8S - 1.$MAX_K8S"
            exit 1
          fi

          if [ "$K8S_MINOR" -lt "$MIN_K8S" ]; then
            echo "❌ Error: Kubernetes $K8S_VERSION is too old for Talos $TALOS_VERSION"
            echo "   Talos $TALOS_MINOR supports Kubernetes 1.$MIN_K8S - 1.$MAX_K8S"
            exit 1
          fi

          echo "✅ Kubernetes $K8S_VERSION is compatible with Talos $TALOS_VERSION"
          echo "   (Talos $TALOS_MINOR supports Kubernetes 1.$MIN_K8S - 1.$MAX_K8S)"
